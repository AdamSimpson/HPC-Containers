# Defines a Singularity container with TensorFlow pre-installed
#
BootStrap: docker
From: ubuntu:zesty

%setup
  # Setup the environment to be sued in the container
  echo "" >> ${SINGULARITY_ROOTFS}/environment
  echo "export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/cuda/bin:/usr/lib/jvm/java-8-openjdk-amd64/bin" >> ${SINGULARITY_ROOTFS}/environment
  echo "export LD_LIBRARY_PATH=/usr/local/lib:/usr/local/cuda/lib64:/usr/local/cuda/extras/CUPTI/lib64:/usr/lib/nvidia" >> ${SINGULARITY_ROOTFS}/environment
  echo "export CUDA_HOME=/usr/local/cuda" >> ${SINGULARITY_ROOTFS}/environment
  echo "export GRADLE_USER_HOME=${HOME}" >> ${SINGULARITY_ROOTFS}/environment
  echo "export JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64" >> ${SINGULARITY_ROOTFS}/environment
  echo "export PROTOC=/usr/local/bin/protoc" >> ${SINGULARITY_ROOTFS}/environment
  echo "export GRPC_JAVA_PLUGIN=/usr/local/bin/protoc-gen-grpc-java" >> ${SINGULARITY_ROOTFS}/environment
  echo "unset PYTHONSTARTUP" >> ${SINGULARITY_ROOTFS}/environment
  echo "BOOTSTRAP_WORKDIR=${BOOTSTRAP_WORKDIR}" >> ${SINGULARITY_ROOTFS}/environment

  ####
  # Setup Cray MPI
  # These variables are expected to be set at container runtime(e.g. in the module file loading the container)
  # SYSUTILS_DEFAULT_DIR=`readlink -f /opt/cray/sysutils/default`
  # WLM_DEFAULT_DIR=`readlink -f /opt/cray/wlm_detect/default`
  # GNU_MPICH_LIB_DIR=`readlink -f /opt/cray/mpt/default/gni/mpich-GNU/5.1/lib`
  ####

  # Make sure Cray MPICH libraries are in container LD_LIBRARY_PATH
  echo "export LD_LIBRARY_PATH="'${GNU_MPICH_LIB_DIR}:${LD_LIBRARY_PATH}:${CRAY_LD_LIBRARY_PATH}:${SYSUTILS_DEFAULT_DIR}/lib64:${WLM_DEFAULT_DIR}/lib64'":/lib64:/usr/lib/x86_64-linux-gnu" >> ${SINGULARITY_ROOTFS}/environment

  # Hack because bazel spins up daemons that confuse singularity during shutdown resulting is leftover files
  rm -rf /root/.cache/bazel

%post
  . /environment
  . ./tensorflow.post

%runscript
    exec /usr/bin/python "$@"
